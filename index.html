<!DOCTYPE html>
<title>The State of Humanitarian Aid</title>
<meta charset="utf-8">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
<META HTTP-EQUIV="Expires" CONTENT="-1">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<meta name="description" content="In just over a decade, the number of people in need of aid has more than doubled. At the beginning of 2015 we were aiming to assist 57.5 million people in 22 countries needing assistance.">
<meta name="keywords" content="Humanitarian Aid, UNOCHA, OCHA, United Nations">
<meta property="og:image" content="http://www.unocha.org/stateofaid/img/cover.png"/>
<meta property="og:title" content="The State of Humanitarian Aid"/>
<meta property="og:description" content="In just over a decade, the number of people in need of aid has more than doubled. At the beginning of 2015 we were aiming to assist 57.5 million people in 22 countries needing assistance."/>


<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700,800">
<link rel="stylesheet" href="./css/leaflet.css" />
<script src='./js/mapbox.js'></script>
<link href='./css/mapbox.css' rel='stylesheet' />
<link href='./css/c3.css' rel='stylesheet' />
<link href='./css/custom.css?v=1.1' rel='stylesheet' />
<link media="only screen and (max-width: 700px)" href="./css/mobile-custom.css" rel='stylesheet' />
<style>

</style>


<body>

  <!-- FB -->
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3&appId=449161795236219";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>
  <!-- ENDOF FB -->

  <aside class='hubscroll-nav-area'>
    <nav class='hubscroll-nav-viewport'>
      <ul class='hubscroll-nav-list'>
      </ul>
    </nav>
  </aside>

<!-- data-next-0="ocha.Story.titleProcess1"
           data-next-1="ocha.Story.titleProcess2" -->
 <section id="mosaic-area" class="hub-section hub-neutral-background"
           data-next-before="ocha.Story.titleToOpening"
           data-next="fade"

           data-next-after="ocha.Story.reshowImages">
    <div id="mosaic-actual"></div>
    <div id="mosaic-overlay-area"></div>
    <div id="mosaic-title-area">
      <h1>The State of Humanitarian Aid</h1>
      <!-- <h2>The State of Aid</h2> -->
    </div>
  </section>

  <section class="hub-section" id="hub-slide-1" data-next="fade">
    <div class='hub-viewport'>
      <div class="content" id="hub-slide-1-good-news">
        <h1>The Good News:</h1>
        <p>We are doing more for more people than ever before.</p>
      </div>
      <div class='hub-photo-credit hub-photo-credit-right'>Credit: OCHA/Yasmina Guerda/Sierra Leone, 2014 </div>
    </div>
  </section>

  <section class="hub-section" id="hub-slide-1-a" data-prev="fade">
    <div class='hub-viewport'>
      <div class="content" id="hub-slide-1-bad-news">
        <h1>The Bad News:</h1>
        <p>The humanitarian system is under unprecedented strain.</p>
      </div>
      <div class='hub-photo-credit hub-photo-credit-right'>Credit: UNICEF/Lebanon, 2012</div>
    </div>
  </section>

  <section class="hub-section hub-neutral-background" id="hub-slide-2" data-next-0="ocha.Story.playNextChartText" data-on-init="ocha.Story.loadChart">
    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content hub-subsection' id="content-2-a">
        <h2>In&nbsp;just&nbsp;over&nbsp;a&nbsp;decade,&nbsp;the&nbsp;number&nbsp;of people&nbsp;in&nbsp;need&nbsp;of&nbsp;aid&nbsp;has&nbsp;more&nbsp;than&nbsp;doubled. At the beginning of 2015 we were aiming to assist <strong style="color: #811B1B; text-shadow: 2px 2px 1px rgba(0,0,0, 0.2);">57.5&nbsp;million&nbsp;people</strong> in&nbsp;22&nbsp;countries&nbsp;needing&nbsp;assistance.</h2>
      </div>
      <div class='content hub-subsection' id="content-2-b">
        <h2>
          Six&nbsp;months&nbsp;later,&nbsp;we&nbsp;are&nbsp;calling&nbsp;for&nbsp;help&nbsp;to support&nbsp;an astounding&nbsp;<strong style="color: #811B1B; text-shadow: 2px 2px 1px rgba(0,0,0, 0.2);">82.5&nbsp;million&nbsp;people</strong>.

          We&nbsp;need&nbsp;<strong style="color: #ff7f0e">$19.7&nbsp;billion</strong>&nbsp;to&nbsp;help&nbsp;them.
        </h2>
      </div>
      <div id="chart-container">
        <div id="chart-area" class='chart'></div>
      </div>
    </div>
  </section>

  <section class="hub-section hub-neutral-background" data-next="fade" id="hub-slide-3">
    <div class='hub-viewport'>
      <div class='hub-radial-overlay' style="opacity: 0.3"></div>
      <div class='content'>
          <h2>In many countries, violence and insecurity<br/>continue to cause massive internal<br/>and cross-border displacement.<br/><br/>In 2015 alone, </h2> <h1>700,000 people have been newly displaced in Iraq.</h1>
      </div>
    </div>
  </section>

  <section class="hub-section" id="hub-slide-4" data-on-init="ocha.Story.startIraqCounter">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Iraq</h2></div>
      <div class='hub-country-stats'>
          <table>
            <tr>
              <td class='td-right'>
                <span class='country-stat-count' data-stat-count='8200000'>0</span>
              </td>
              <td class='td-left'>
                <span class=''>people in need of assistance</span>
              </td>
            </tr>
            <tr>
              <td class='td-right'>
                <span class='country-stat-count' data-stat-count='60'>0</span>%
              </td>
              <td class='td-left'>
                of frontline humanitarian operations at risk of shutting down due to underfunding
              </td>
            </tr>
          </table>
      </div>
      <div class='hub-photo-credit'>Credit: OCHA/Charlotte Cans/Iraq, 2015 </div>
    </div>
  </section>
  <section class="hub-section" id="hub-slide-5" data-on-init="ocha.Story.startSyriaCounter">
    <div class='hub-viewport'>
        <div class='hub-country-title'><h2>Syria</h2></div>
        <div class='hub-country-stats abs-left'>
          <table>
            <tr>
              <td class='td-right'><span class='country-stat-count' data-stat-count='4000000'>0</span></td>
              <td class='td-left'>forced across borders<div class="clear"></div></td>
            </tr>
            <tr>
              <td class='td-right'><span class='country-stat-count' data-stat-count='4800000'>0</span></td>
              <td class='td-left'>people living in hard-to-reach or besieged locations<div class="clear"></div></td>
            </tr>
          </table>
        </div>
        <div class='hub-photo-credit hub-photo-credit-right'>Credit: UNHCR/S. Rich/Jordan, 2013</div>
      </div>
  </section>
  <section class="hub-section"  id="hub-slide-6" data-on-init="ocha.Story.startSouthSudanCounter">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>South Sudan</h2></div>
      <div class='hub-country-stats'>
        <table>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='1500000'>0</span></td>
            <td class='td-left'>internally displaced<div class="clear"></div></td>
          </tr>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='4600000'>0</span></td>
            <td class='td-left'>severely food insecure<div class="clear"></div></td>
          </tr>
        </table>
      </div>
      <div class='hub-photo-credit'>Credit: UN Photo/JC McIlwaine/South Sudan, 2015</div>
    </div>
  </section>
  <section class="hub-section" id="hub-slide-7" data-on-init="ocha.Story.startYemenCounter">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Yemen</h2></div>
      <div class='hub-country-stats'>
        <table>
          <tr><td class='td-right'><span class='country-stat-count' data-stat-count='21400000'>0</span></td>
            <td class='td-left'>people in dire need of assistance</td>
          </tr>
          <tr><td class='td-right'><span class='country-stat-count' data-stat-count='20400000'>0</span></td>
            <td class='td-left'>people need access to clean water and sanitation</td>
          </tr>
        </table>
      </div>
      <div class='hub-photo-credit'>Credit: UNICEF/Hamoud/Yemen, 2015</div>
    </div>
  </section>
  <section class="hub-section" data-next="fade" id="hub-slide-8" data-on-init="ocha.Story.startUkraineCounter">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Ukraine</h2></div>
      <div class='hub-country-stats abs-left'>
        <table>
          <tr><td class='td-right'><span class='country-stat-count' data-stat-count='5000000'>0</span></td>
            <td class='td-left'>in need of humanitarian assistance</td>
          </tr>
          <tr><td class='td-right'><span class='country-stat-count' data-stat-count='2200000'>0</span></td>
              <td class='td-left'>uprooted by conflict</td>
        </table>
      </div>
      <div class='hub-photo-credit hub-photo-credit-right'>Credit: UNICEF/Ukraine, 2015</div>
    </div>
  </section>
  <section class="hub-section hub-neutral-background"  data-prev="fade" id="hub-slide-9">

    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
        <h2>Natural disasters of devastating proportions
            <br/>continue to wreak havoc,<br/>flattening villages and
            <br/>reducing entire livelihoods to dust.</h2>
      </div>
    </div>
  </section>
  <section class="hub-section" id="hub-slide-10" data-on-init="ocha.Story.startNepalCounter">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Nepal</h2></div>
      <div class='hub-country-stats'>
        <table>
          <tr>
            <td class='td-left'>
              <span class='country-stat-count' data-stat-count='2800000'>0</span>
            </td>
          </tr>
          <tr>
            <td class="td-left">people displaced by<br/>the 2015 earthquake<div class="clear"></div></td>
          </tr>
        </table>
      </div>
      <div class='hub-photo-credit'  style='color: #333333'>Credit: UNDP/Nepal, 2015 </div>
    </div>
  </section>
  <section class="hub-section" id="hub-slide-10-a" data-on-init="ocha.Story.startSecondNepalCounter">
    <div class='hub-viewport'>
      <div class='hub-radial-overlay-transparent'></div>
      <div class='hub-country-title'><h2>Afghanistan</h2></div>
      <div class='hub-country-stats'>
        <table>
          <tr>
            <td class='td-left'><span class='country-stat-count' data-stat-count='250000'>0</span></td>
          </tr>
          <tr>
            <td class='td-left'>people&nbsp;affected&nbsp;by natural&nbsp;disasters in&nbsp;2015<div class="clear"></div></td>
          </tr>
        </table>
      </div>
      <div class='hub-photo-credit hub-photo-credit-right'>Credit: Fardin Waezi/UNAMA/Afghanistan, 2014</div>
    </div>
  </section>

  <section class='hub-section hub-neutral-background' data-next="fade" id='hub-slide-11'>
    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
        <h2>In many parts of the world, humanitarian&nbsp;crises show&nbsp;no&nbsp;sign of abating.</h2>
        <h1>Protracted is the new normal.</h1>
      </div>
    </div>
  </section>

  <section class='hub-section hub-neutral-background' id="hub-slide-12">
    <div class='hub-viewport'>
      <div class='hub-radial-overlay' style="opacity: 0.55"></div>
      <div class='content'>
        <h2>
        In the <strong style="color: #811B1B;">SAHEL</strong> alone</h2>
        <h1>9 million</h1>
        <h2>women, children and men will go hungry this year if aid doesn't reach them.</h2>
      </div>
      <div class='hub-photo-credit'>Credit: French Red Cross/Sylvain Cherkaoui/Niger, 2012</div>
    </div>
  </section>

  <section class='hub-section hub-neutral-background' id='hub-slide-13'>
    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
        <h2>
          Aid organizations have<br/>achieved a lot so far in 2015. <br/><br/>They have saved lives,<br/>supported the livelihoods and<br/>protected millions of people.
        </h2>
      </div>
    </div>
  </section>

  <section class='hub-section' id='hub-slide-14' data-on-init="ocha.Story.startSomaliaCounter">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Somalia</h2></div>
      <div class='hub-country-stats abs-left'>
        <table>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='331000'>0</span></td>
            <td class='td-left'>received food assistance<div class="clear"></div></td>
          </tr>
          <tr>
            <td class='td-right'>
              <span class='country-stat-count' data-stat-count='140400'>0</span></td>
            <td class='td-left'>received seeds, tools, and fishing equipment<div class="clear"></div></td>
          </tr>
        </table>
      </div>
      <div class='hub-photo-credit hub-photo-credit-right'>Credit: UN Photo/Tobin Jones/Somalia, 2013</div>
    </div>
  </section>

  <section class='hub-section' id='hub-slide-15' data-on-init="ocha.Story.startVanuatuCounter">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Vanuatu</h2></div>
      <div class='hub-country-stats'>
        <table>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='21000'>0</span></td>
            <td class='td-left'>people have received emergency supplies of safe drinking water<div class="clear"></div></td>
          </tr>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='55000'>0</span></td>
            <td class='td-left'>received tool kits to rebuild their homes<div class="clear"></div></td>
          </tr>
        </table>
      </div>
      <div class='hub-photo-credit'>Credit: UNICEF Pacific/Vanuatu, 2015</div>
    </div>
  </section>

  <section class='hub-section hub-neutral-background' id='hub-slide-16' data-next="fade"

      data-on-init="ocha.Story.showSecondFace"
      data-next-before="ocha.Story.hideAllForMap"

    data-next-0="ocha.Story.remove16_00"
    data-next-1="ocha.Story.remove16_01"
    data-next-2="ocha.Story.remove16_02"
    >
    <div class='hub-viewport'>
      <div id='hub-face-final-area'></div>
      <div class='hub-radial-overlay'></div>
      <div class='content hub-subsection' id="hub-16-00">
        <h2>
          But each year millions of people<br/>do not get the help they need because</h2>
        <h1>humanitarian access is compromised.</h1>
      </div>
      <div class='content hub-subsection' id="hub-16-01">
        <h2>Or because </h2>
        <h1>funding does <br/> not come through.</h1>
      </div>
      <div class='content hub-subsection' id="hub-16-02">
        <h2>
          Donors have been generous but the global humanitarian appeal remains just
        </h2>
        <h1>26 per cent funded</h1>
        <h2>half-way through the year.</h2>
      </div>
      <div class='content hub-subsection' id="hub-16-03">
        <h2>
          One thing is clear: the sheer scale of needs continues to outpace the level of funding.
        </h2>
      </div>
    </div>
  </section>

  <section class='hub-section' id='hub-slide-17' data-on-init="ocha.Story.loadGHOMap" data-mobile-hide="true">
    <div class='hub-viewport'>
      <div class='content'
            style="z-index: 1; opacity: 0.6; color: white; position: absolute; top: 40%; width: 100%; text-align: center; font-size: 6em; text-transform: uppercase" id="loading-map-item">LOADING MAP</div>
      <div class='content' style="z-index: 100;">
        <iframe id='hub-slide-map' data-loaded='false' scrolling="no" border="no" style="position:relative;">
        </iframe>
      </div>
    </div>
  </section>

  <section class='hub-section hub-neutral-background' id='hub-slide-18' data-next="fade">
    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
        <h1>Together we can turn this around.</h1>
      </div>
    </div>
  </section>
  <section class='hub-section hub-neutral-background' id='hub-slide-19' data-next="fade">
    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
        <h2>We can do more to help every child, woman
        <br/>and man, from Chad to Yemen, to receive the
        <br/><strong style="color: #811B1B">life saving assistance</strong> that they deserve &dash;
        <br/>if we <strong style="color: #811B1B">fully fund</strong> the humanitarian response in 2015.</h2>
      </div>
    </div>
  </section>

  <section class='hub-section hub-neutral-background' id='hub-call-to-action'>
    <div class='hub-viewport'>
      <div class='hub-radial-overlay' style="opacity: 0.5"></div>
      <div class='content'>
        <h2>Let's achieve more. TOGETHER.</h2>
        <div id='hub-call-to-action-area'>
          <div id='call-to-action-share' class='hub-call-to-action-3box'>
            <h3>Spread the word</h3>
            <div>
              <ul>
                <li>
                  <a class="facebook-logo" id="facebook-link" target="_blank" href="javascript: void(0);"><img src="img/facebookicon.png" /> <span style='vertical-align: middle; display: inline-block'>Share on Facebook</span></a>
                </li>
                <li>
                  <a class="twitter-logo" href="javascript: void(0);"><img src="img/twittericon.png" /> <span style='vertical-align: middle; display: inline-block'>Share on Twitter</span></a>
                </li>
              </ul>
            </div>
          </div>
          <div id='call-to-action-donate' class='hub-call-to-action-3box'>
            <h3>Donate</h3>
            <p>
          Support relief efforts by donating to OCHA managed pooled funds. Every dollar counts.
            </p>
            <p style='text-align: center'>
              <a href='http://www.unfoundation.org/how-to-help/donate/support-unherf.html' class='hub-button' target="_blank">Donate</a>
            </p>
          </div>
          <div id='call-download-report' class='hub-call-to-action-3box'>
            <h3>Learn more</h3>
            <table>
              <tr>
                <td>
                  <a href='https://docs.unocha.org/sites/dms/Documents/GHO-status_report-FINAL.pdf' target="_blank">
                    <img src='./img/story/gho-cover.png' />
                  </a>
                </td>
                <td>
                  <a href="https://docs.unocha.org/sites/dms/Documents/GHO-FINAL-web.pdf" target="_blank">
                    <img src='./img/story/gho-cover-dec2014.png' />
                  </a>
                </td>
              </tr>

              <tr>
                <td>
                  <a href='https://docs.unocha.org/sites/dms/Documents/GHO-status_report-FINAL.pdf' target="_blank" class='hub-button'>Jun 2015</a>
                </td>
                <td>
                  <a href='https://docs.unocha.org/sites/dms/Documents/GHO-FINAL-web.pdf' target="_blank" class='hub-button'>Dec 2014</a>
                </td>
              </tr>
            </table>
            <div class="clear"></div>
          </div>
          <div class='clear'></div>
        </div>
      </div>
      <div class='hub-photo-credit'>Credit: OCHA/David Gough/2013</div>
    </div>
  </section>




<script src="./js/jquery-1.11.3.min.js"></script>
<script src="./js/d3.js"></script>
<script src="./js/c3.js"></script>
<script src="./js/topojson.js"></script>
<script src="./js/leaflet.js"></script>

<script type="text/javascript">
$j = jQuery;


var IMAGE_COUNT = 54;

var ANIMATION_DURATION = 1000;

var ocha = ocha || {};
var faceWidth = $(window).width() < 1400 ? 50 : 75;

ocha.FaceMosaic = function(selector, imageList, squareSize) {

//Private function to help the hide


  this.TIMEOUT_PERIOD = 2000;

  this.SQUARE_SIZE = squareSize || 50; //suggested square_size
  this.FADE_DURATION = 200;

  this.imageList = imageList;
  this.container = $j(selector);
  this.d3Container = d3.select(selector);
  this.d3Scale = null;

  this.transitionOngoing = false;

  // console.log(this.container);
  this.mW = this.container.width(); //mosaic Width
  this.mH = this.container.height(); //mosaic Height

  //console.log(this.mH, this.mW);

  this.scaleHorizontal = d3.scale.ordinal().domain(d3.range(parseInt(this.mW/this.SQUARE_SIZE) + 2)).rangeRoundBands([0,this.SQUARE_SIZE  * (parseInt(this.mW/this.SQUARE_SIZE) + 2)]);

  this.mosaicIntervalHandler = null;

  this.mosaicDimension = [ this.SQUARE_SIZE  * (parseInt(this.mW/this.SQUARE_SIZE) + 2),
                          this.SQUARE_SIZE  * (parseInt(this.mH/this.SQUARE_SIZE) + 2)]

  this.eventActive = false;

  this.helper = {

  }

  this.startMosaic = function() {
    var that = this;

    that.mosaicIntervalHandler = setInterval(function() {
      // //console.log("Hello World");
      that.d3Container
        .selectAll("span.mosaic-item")
        .each(function(d) {

          var coinFlip = Math.random() * 100;
          if ( coinFlip > 80 ) {  //get new and replace
            var randomIndex = parseInt(that.imageList.length * Math.random());
            var toBeRemoved = d3.select(this).select("img");

            toBeRemoved
              .attr("data-image-status", "for-removal")
              .style("z-index", "0");

            // //console.log(that.imageList[randomIndex]);
            var toBeAdded = d3.select(this).append("img")
              .attr("data-image-status", "new-image")
              .attr("src", that.imageList[randomIndex])
              .style("opacity", 0)
              .style("z-index", "100");

            toBeAdded.transition()
              .duration(500 + that.TIMEOUT_PERIOD)
              .delay(Math.random() * that.TIMEOUT_PERIOD)
              .style("opacity", 1)
              .each("end", function() { toBeRemoved.remove(); });
          }

        });

    }, that.TIMEOUT_PERIOD);
  };

  this.stopMosaic = function() {
    var that = this;
    clearTimeout(that.mosaicIntervalHandler);
  };

  this.initialize();
};

ocha.FaceMosaic.prototype.endAllEvent = function ( transition, callback ) {

  var n = 0;
  transition
    .each(function() { ++n; })
    .each("end", function() { if (!--n && callback !== undefined) {

        callback.apply(this, arguments);
    } });
};

ocha.FaceMosaic.prototype.reshowImages = function() {
  var that = this;
  that.mosaicRows.selectAll("span.mosaic-item").style("opacity", 1);
};
ocha.FaceMosaic.prototype.initialize = function () {
  var that = this;
  // console.log(that.d3Container.selectAll);
  that.container.addClass("mosaic-container");
  that.mosaicRows = that.d3Container
                      .selectAll("div.mosaic-row")
                      .data(d3.range(parseInt((this.mH/this.SQUARE_SIZE) + 2)))
                      .enter()
                        .append("div")
                          .attr("class", "mosaic-row")
                          .style("height", that.scaleHorizontal.rangeBand() + "px")
                          .style("width", that.SQUARE_SIZE*(parseInt(that.mW/that.SQUARE_SIZE) + 2) + "px")
                          .attr("data-row-id", function(d) { return "row-id-" + d;})
                          .each(function(d) {
                            //Creating individual item..
                             d3.select(this).selectAll("span.mosaic-item")
                                .data(d3.range(parseInt(that.mW/that.SQUARE_SIZE + 2)))
                                .enter()
                                  .append("span")
                                    .attr("class", "mosaic-item")
                                    .style("width", that.scaleHorizontal.rangeBand() + "px")
                                    .style("height", that.scaleHorizontal.rangeBand() + "px")
                                    .each(function() {
                                      var randomIndex = that.imageList.length * Math.random();

                                      var newImage = d3.select(this).append("img")
                                          .attr("src", that.imageList[parseInt(randomIndex)])
                                          .attr("data-image-status", "new-image")
                                          .style("opacity", 0);

                                      newImage.transition()
                                          .duration(that.FADE_DURATION)
                                          .delay(Math.random() * that.TIMEOUT_PERIOD)
                                          .style("opacity", 1);
                                    })
                          });

    // this.startMosaic();
    $("html,body").css("overflow", "auto");
};

ocha.FaceMosaic.prototype.hide = function (userDefMode, callback) {
  var that = this;
  var mode = "fade";


  if (userDefMode !== undefined) {
    mode = userDefMode;
  }

  // console.log("Callback", callback);

  switch (mode) {
    case "fade" :
      that.d3Container
        .selectAll("span.mosaic-item")
          .transition()
            .duration(that.FADE_DURATION)
            .delay(function() { return Math.random() * that.TIMEOUT_PERIOD; })
            .style("opacity", 0)
            .call(that.endAllEvent, callback);

      break;
    default:
      break;
  }

  // if ( callback ) {
  //   console.log("calling call back");
  //   callback();
  // }
};

//* Hub Section Scrolling */
var ocha = ocha || {};
ocha.HubScrolling = function(sections, options) {
  var $j = jQuery;

  this.scroller = null;

  // this.isMobile = true;
  this.isMobile = (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()));

  this.currentSubPage = 0;

  this.currentPage = null, this.nextPage = null;
  this.currentPageNumber = 0;
  this.d3Containers = d3.selectAll(sections[0]);

  // console.log(sections);
  this.containers = this.isMobile
                      ? $j(sections.filter(function(d, item) {
                          // console.log(d, item);
                          var hideIfMobile = ( $(item).attr("data-mobile-hide") || "false" ) == "true";
                          return !hideIfMobile;
                        }))
                      : $j(sections) ;

  // console.log("XXX" , this.containers);
  this.pageCount = this.containers.length;

  //Scrolling items:
  this.scrollPositionTop = $(window).scrollTop();
  this.scrollPositionBottom = $(window).scrollTop();

  this.options = $.extend({

    transitionSpeed: 1000

  }, options);
};

ocha.HubScrolling.prototype.windowListenerNext = function(d) {
      //console.log("XXX");
      var that = d.data;

      var h = that.containers.height();
      var limit = h/4; //1/10 of the height;


      var scrollTop = $(window).scrollTop();
      var target = that.surrogates.filter(function(i, item) {
        var topOffset = $(item).offset().top;
        // console.log("Limit ::: ", topOffset+limit+limit, scrollTop, topOffset+limit, (topOffset+limit+limit > scrollTop && scrollTop > topOffset+limit) ? "TRUE" : "FALSE");
        return (topOffset+limit > scrollTop && scrollTop > topOffset);
      });

    // console.log("XXXX", target, scrollTop);

    // if ($(target).length) {
    //   console.log($(target).attr("data-page-scroll"), scrollTop);
    // }

    // console.log(that.currentPageNumber)
    // console.log(target, $(target).attr("data-page-scroll"));
    //Determine if he user scrolled up or down..
    // if ( target.length > 0 ) {
      if (target.length > 0  && scrollTop > that.scrollPositionTop) {

        that.currentPageNumber = parseInt($(target).attr("data-page-scroll"));
        // console.log(that.currentPageNumber);
        // console.log("NEXT()", target, that.currentPageNumber);
        d.data.next();
      }
      else if (target.length > 0  && scrollTop < that.scrollPositionTop) {
        // console.log("FROM WINDOW LISTENER NEXT ::: PREV()", target, that.currentPageNumber);
      // //   // d.data.prev();
      }
    // }

    that.scrollPositionTop = scrollTop;

    // console.log("HUBSCROLLING ::: ", hubScrolling.scrollPosition);
    //$(window).off("scroll", that.windowListener);

};

ocha.HubScrolling.prototype.keyPressDown = function(e) {
    var that = e.data;
    // console.log(that, e);
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 40) {
        e.data.next();
    } else if (code == 38) {
        e.data.previous();
    }
};

ocha.HubScrolling.prototype.windowListenerPrev = function(d) {
    var that = d.data;


    // console.log("XXX");
    var h = that.containers.height();
    var limit = h/4; //1/10 of the height;

    var scrollTop = $(window).scrollTop();
    // console.log(scrollTop);
    var target = that.surrogates.filter(function(i, item) {
      // console.log( "TOP OFFSET :: ", $(item).offset().top );

      var topOffset = $(item).offset().top;

      // console.log(topOffset+limit+5, scrollTop, topOffset+limit);
      // console.log(topOffset-limit, scrollTop, topOffset-limit-5);

      // console.log("RESULT", (topOffset+limit+5 < scrollTop && scrollTop > topOffset+limit) ||
             // (topOffset-limit < scrollTop && scrollTop > topOffset-limit-5));

      // if (topOffset+limit+50 > scrollTop && scrollTop > topOffset+limit) {
      //   // console.log("TOP OFFSET " , limit,  topOffset);
      // }

      return (topOffset > scrollTop && scrollTop > topOffset-limit);

    });

    // console.log("XXXX", target.length, scrollTop);

    // if ($(target).length) {
    //   console.log($(target).attr("data-page-scroll"), scrollTop);
    // }


    // console.log(target, $(target).attr("data-page-scroll"));
    //Determine if he user scrolled up or down..
    if (target.length > 0  && scrollTop < that.scrollPositionBottom) {
      that.currentPageNumber = parseInt($(target).attr("data-page-scroll"));
      // if (scrollTop > that.scrollPosition) {
        // console.log("PREV()", target, that.currentPageNumber, that);
        that.previous();
      // }
      // else {
      //   console.log("PREV()", target);
      //   // d.data.prev();
      // }
    }

    that.scrollPositionBottom = scrollTop;

    // console.log("HUBSCROLLING ::: ", hubScrolling.scrollPosition);
    //$(window).off("scroll", that.windowListener);

}

ocha.HubScrolling.prototype.skipPage = function(d) {
  //d.data.that;
  var hash = window.location.hash;

  var $links = $("aside.hubscroll-nav-area ul.hubscroll-nav-list li a");
  var $activeLinks = hash != ""
                        ? $("aside.hubscroll-nav-area ul.hubscroll-nav-list li a[href=" + hash + "]")
                        : $("aside.hubscroll-nav-area ul.hubscroll-nav-list li:first-child a");

  $links.removeClass("hubscroll-nav-active");
  $activeLinks.addClass("hubscroll-nav-active");

  var $currentPage = $("section.hub-section[data-page=" + d.data.currentPageNumber + "]");
  var $nextSurrogate = $("div" + hash + ".hub-container-scroll");

  var nextPageNumber = $nextSurrogate.attr("data-page-scroll");

  var $nextPage = $("section.hub-section[data-page=" + nextPageNumber + "]");

  // console.log($currentPage.attr("data-next"), $currentPage.attr("data-prev"));
  var nextTransition = $currentPage.attr("data-next") || "scrollUp";
  var prevTransition = $currentPage.attr("data-prev") || "scrollDown";

  var transition = (parseInt($currentPage.attr("data-page")) < parseInt($nextPage.attr("data-page")))
                      ? nextTransition
                      : prevTransition;

  // console.log(transition);

  // console.log("CURRENT DATA PAGE ::: ", $currentPage, d.data.currentPageNumber);
  // console.log("NEXT DATA PAGE ::: ", $nextPage, nextPageNumber);
  // var currentPage = d.data.currentPage;
  // var nextPage = d.data.nextPage;

  if (d.data.currentPageNumber != $nextPage.attr("data-page") )
  {
    d.data.currentPageNumber = $nextPage.attr("data-page");



    $("html,body").css("overflow", "hidden");
    if ( !d.data.isMobile ) {
      $(window).off("scroll", d.data.windowListenerNext);
      $(window).off("scroll", d.data.windowListenerPrev);
    } else {
      $("body").off("touchmove", d.data.windowListenerNext);
      $("body").off("touchmove", d.data.windowListenerPrev);
    }


    d.data.transition($currentPage, $nextPage, transition);
    $("html,body").animate({ scrollTop : $nextSurrogate.offset().top}, d.data.options.transitionSpeed,
      function() {


        if ( !d.data.isMobile ) {
          $(window).on("scroll", d.data, d.data.windowListenerNext);
          $(window).on("scroll", d.data, d.data.windowListenerPrev);
        } else {
          $("body").on("touchmove", d.data, d.data.windowListenerNext);
          $("body").on("touchmove", d.data, d.data.windowListenerPrev);
        }
        // $(window).on("keydown", that, that.keyPressDown);
        // }
        $("html,body").css("overflow", "auto");
    });
  }
};


ocha.HubScrolling.prototype.initialize = function() {
  var that = this;
  that.resizeWindow();

  var scrollTop = $("html,body").scrollTop();
  // console.log("!!! SCROLL TOP: ", scrollTop);
  //Add data-page counter;
  var $linkArea = $("aside.hubscroll-nav-area nav ul.hubscroll-nav-list");
  this.containers.each(
      function(i, item) {

        if(!that.isMobile) {
            $j(item)
              .attr("data-page", i)
              .css({
                  "position": "fixed",
                  "zIndex" : ( that.pageCount - i ) * 100,
                  "top" : i != 0 ? that.containers.height() : 0,
                  "left" : 0
              });

              //Insert surrogate containers
              var $surrogate = $("<div />")
                              .addClass("hub-container-scroll hub-surrogate")
                              .attr("data-page-scroll", i)
                              .attr("id", $(item).attr("id") ? $(item).attr("id") : "page-" + i)
                              .width(that.containers.width())
                              .height(that.containers.height());


              $("body").append($surrogate);

              var $link = $("<li/>")
                              .addClass("hubscroll-nav-list-item")
                              .append($("<a/>")
                                  .attr("data-target", i)
                                  .attr("href", "#"
                                                    + ($(item).attr("id") ? $(item).attr("id") : "page-" + i) )
                                                    ) ;

              // console.log($linkArea, $link);
              $linkArea.append($link);
              // <li class='hubscroll-nav-list-item'><a href="#hub-slide-18"></a></li>


              // if ($surrogate.position().top < scrollTop) {
              //   $surrogate.css("visibility", "hidden");
              // }
            } else { // if hubscrolling is in mobile...
              // var newH = $("#hub-slide-16").height() * 1.5;
              // $("#hub-slide-16").height(newH);

              lastMosaic = new ocha.FaceMosaic("#hub-slide-16 #hub-face-final-area",
                                  d3.range(IMAGE_COUNT)
                                    .map(function(d) { return "./img/faces/" + fmt(d) + ".png"; }),
                                    faceWidth);

              lastMosaic.initialize();
              countryChart.initialize();

              d3.selectAll(".country-stat-count").each(function(d) {
                var count = parseInt(d3.select(this).attr("data-stat-count"));
                var format = d3.formatPrefix(count);

                format.symbol = format.symbol == "G" ? "B" : format.symbol;
                d3.select(this).text(format.scale(count) + "" + format.symbol);
              });

              $("section.hub-section").css("opacity", 1);
            }

      }
  );

  $linkArea.closest("aside.hubscroll-nav-area").css("margin-top", "-" + $linkArea.height()/2 + "px");

  // this.containers.each(function(i, item) {
  //     var $target = $("[data-page-scroll=" + i+ "]");

  //     // console.log("DISTANCE", i,  $(window).scrollTop(), $("[data-page-scroll=" + i+ "]").offset().top - $(window).scrollTop());

  //     if ($target.offset().top - $(window).scrollTop() < 0) {
  //       // console.log("HIDDEN : ", $($(".hub-section")[i]));
  //       $($(".hub-section")[i]).css("top", "100%");

  //     }
  //     else {
  //       $($(".hub-section")[i]).css("opacity", 1)
  //       $($(".hub-section")[i]).css("top", "0px")
  //     }


  // });

  this.surrogates = $("body > .hub-surrogate");


    // if (!this.eventActive) {
    //   this.eventActive = true;

  if ( !that.isMobile ) {
    $(window).on("scroll", that, that.windowListenerNext);
    $(window).on("scroll", that, that.windowListenerPrev);
  } else {
    // $("body").on("touchmove", that, that.windowListenerNext);
    // $("body").on("touchmove", that, that.windowListenerPrev);
  }

  if ( !that.isMobile ) {
    $(window).on("hashchange", that, that.skipPage);
    $(window).trigger("hashchange");
  }
    // }

  //Event listeners
  $j(window).on("resize", function () { that.resizeWindow(); });
  // $j(window).on("keydown", that, that.keyPressDown);
};

ocha.HubScrolling.prototype.stopScrolling = function() {

};

ocha.HubScrolling.prototype.resizeWindow = function() {
  var that = this;
  var $window = $j(window);
  var w = $window.width(),
      h = $window.height();

  // if ( !that.isMobile ) {
    that.containers.width(w);
    that.containers.height(h);

    // if ( that.isMobile ){
    //   that.containers.height("auto");
    //   that.containers.css("minHeight", h);
    // }
  // } else {
  //   that.containers.height(window.screen.height);
  //   that.containers.width(window.screen.width);
  //   // that.containers.height(document.documentElement.clientWidth);
  // }
  //For the scroller at the background
  // if (!this.scroller) {
  //   var wAll = that.containers.width(),
  //       hAll = that.containers.height() * pageCount;
  // }
};

ocha.HubScrolling.prototype.previous = function() {
  // $("html,body").css("overflow", "hidden");

  var that = this;

  // // console.log("XXXXX");

  // $(window).off("scroll", that.windowListenerNext);
  // $(window).off("scroll", that.windowListenerPrev);
  // // $(window).off("keydown", that.keyPressDown);
  // // that.eventActive = false;

  // var currentPage = $(this.containers.filter(function(d, item) { return parseInt($(item).attr("data-page")) == that.currentPageNumber; }));

  // var currentSurrogate = $(this.surrogates.filter(function(d, item) { return parseInt($(item).attr("data-page-scroll")) == that.currentPageNumber; }));


  // // console.log(currentPage, currentSurrogate);
  // var nextPage = this.surrogates.filter(function(d, item) { return parseInt($(item).attr("data-page")) == that.currentPageNumber-1; });

  var nextSurrogate = $(that.surrogates.filter(function(d, item) {
    return parseInt($(item).attr("data-page-scroll")) == that.currentPageNumber-1; }));


  window.location.hash = nextSurrogate.attr("id");

  //   var mode = "scrollDown";

  //   if ( currentPage.attr("data-prev") !== undefined ) {
  //     mode = currentPage.attr("data-prev");
  //   }

  //   var callback = currentPage.attr("data-prev-after");
  //   // console.log("Mode, Callback", currentPage, mode, callback);

  //   var func = null;
  //   if (callback !== undefined) {
  //     func = eval(callback);
  //   } else {
  //     func = function(){};
  //   }

  //   that.currentPageNumber --;

  //   //Scroll towards new surrogaete
  //   var currentSurrogate = $(that.surrogates.filter(function(d, item) { return parseInt($(item).attr("data-page-scroll")) == that.currentPageNumber; }));

  //   console.log("TRANSITION !!!!!! ::: ", currentPage, nextPage);
  //   that.transition(currentPage, nextPage, mode, func);

  //   //Reset Subpage
  //   that.currentSubPage = 0;

  //   $("html,body").animate({ scrollTop : currentSurrogate.offset().top}, that.options.transitionSpeed,
  //     function() {

  //       that.transitionOngoing = false;
  //       that.scrollPositionTop = $(window).scrollTop();
  //       that.scrollPositionBottom = $(window).scrollTop();
  //       // console.log("XX");
  //       // if (!that.eventActive) {
  //       //   that.eventActive = true;
  //       $(window).on("scroll", that, that.windowListenerNext);
  //       $(window).on("scroll", that, that.windowListenerPrev);
  //       // $(window).on("keydown", that, that.keyPressDown);
  //       // }
  //       $("html,body").css("overflow", "auto");
  //     }
  //   );
};

ocha.HubScrolling.prototype.next = function() {

  $("html,body").css("overflow", "hidden");
  var that = this;
  // var that = this;
  // that.eventActive = false;

  if ( !that.isMobile ) {
    $(window).off("scroll", that.windowListenerNext);
    $(window).off("scroll", that.windowListenerPrev);
  } else {
    $("body").off("touchmove", that.windowListenerNext);
    $("body").off("touchmove", that.windowListenerPrev);
  }

  // $(window).off("keydown", that.keyPressDown);

  var currentPage = $(this.containers.filter(function(d, item) { return parseInt($(item).attr("data-page")) == that.currentPageNumber; }));

  var currentSurrogate = $(that.surrogates.filter(function(d, item) { return parseInt($(item).attr("data-page-scroll")) == that.currentPageNumber; }));


  // console.log(currentPage, currentPage.attr("data-current-subpage"))
  var currentSubPage = currentPage.attr("data-current-subpage") || 0;
  // console.log("Entered here");
  if ( currentPage.attr("data-next-" + currentSubPage) != undefined ) {
    // console.log("Entered here too");
    // console.log("CURRENT SUBPAGE", currentSubPage);
    currentSubPage = parseInt(currentSubPage);
    currentPage.attr("data-subpage", currentSubPage);
    var action = currentPage.attr("data-next-" + currentSubPage);
    var func = eval(action);

    // console.log("Assessing subpages." , func, action);

    //Execute Subpage
    func();
    currentPage.attr("data-current-subpage", currentSubPage + 1);

    // setTimeout(function() {
    //   // console.log("TURNED ON");

    //   // $("#hub-scrolling-scroller-component").show();
    // }, 500);
    $("html,body").animate({ scrollTop : currentSurrogate.offset().top}, that.options.transitionSpeed,
      function() {
        // console.log("XXXXX About to body");
        that.transitionOngoing = false;
        that.scrollPositionTop = $(window).scrollTop();
        that.scrollPositionBottom = $(window).scrollTop();
        // if (!that.eventActive) {
        //   that.eventActive = true;
        if ( !that.isMobile ) {
          $(window).on("scroll", that, that.windowListenerNext);
          $(window).on("scroll", that, that.windowListenerPrev);
        } else {
          $("body").on("touchmove", that, that.windowListenerNext);
          $("body").on("touchmove", that, that.windowListenerPrev);
        }

          // $(window).on("keydown", that, that.keyPressDown);
        // }
        $("html,body").css("overflow", "auto");
      }
    );
  }
  else
  {
    // console.log("Entered here 3");
    currentPage.attr("data-current-subpage", currentSubPage+1);
    nextPage = this.containers.filter(function(d, item) { return parseInt($(item).attr("data-page")) == that.currentPageNumber+1; });

    this.nextPage = nextPage;
    this.currentPage = currentPage;

    // console.log(this.nextPage ' UNDEFINED ') ;

    if ( this.nextPage.length == 0 ) {
      if ( !that.isMobile ) {
        $(window).on("scroll", that, that.windowListenerNext);
        $(window).on("scroll", that, that.windowListenerPrev);
      } else {
        $("body").on("touchmove", that, that.windowListenerNext);
        $("body").on("touchmove", that, that.windowListenerPrev);
      }
      return;
    }

    var beforeAction = currentPage.attr("data-next-before");
    var func = null;

    try { func = eval(beforeAction); } catch (ex) { func = null; }

    // console.log(beforeAction, func);
    if (beforeAction && func) {
      // console.log("Entered here Y", func);
      func();
    }
    else {
      // console.log("Entered here X");
      that.nextAction();
    }

  }
};

ocha.HubScrolling.prototype.nextAction = function() {
  //Disable scrolling...

  // console.log("DISABLING NEXT ACTION:::");
  // console.log("Entered Here");

  var that = this;
  // console.log(that, that.currentPageNumber);
  var currentPage = that.currentPage;
  var nextPage = that.nextPage;

  var nextSurrogate = $(that.surrogates.filter(function(d, item) {
    return parseInt($(item).attr("data-page-scroll")) == that.currentPageNumber+1; }));

  if ( nextSurrogate.attr("id") != undefined ) {
    window.location.hash = nextSurrogate.attr("id");
  }

  // var mode = $(currentPage).attr("data-next");

  // var callback = $(currentPage).attr("data-next-after");
  // // console.log("Mode, Callback", currentPage, mode, callback);

  // var func = null;
  // if (callback !== undefined) {
  //   try {
  //     console.log("Entered Here", func);
  //     func = eval(callback);
  //   } catch (ex) { func = null; }

  //   // console.log(func);

  // } else {
  //   func = function(){};
  // }

  // that.currentPageNumber ++;

  // // console.log("nextAction", that.surrogates);

  // //Scroll towards new surrogaete


  // // console.log(currentSurrogate);

  // that.transition(currentPage, nextPage, mode, func);

  // //Reset Subpage
  // that.currentSubPage = 0;

  // console.log("Entered Here", that);

  // console.log(currentSurrogate, currentSurrogate.offset(), $(window).scrollTop());
  // $("html,body").animate({ scrollTop : currentSurrogate.offset().top}, that.options.transitionSpeed,
  //   function() {
  //     // console.log("XXXXX About to body");
  //     console.log("Entered Here");
  //     that.transitionOngoing = false;
  //     that.scrollPositionTop = $(window).scrollTop();
  //     that.scrollPositionBottom = $(window).scrollTop();
  //     // if (!that.eventActive) {
  //     //   that.eventActive = true;
  //       $(window).on("scroll", that, that.windowListenerNext);
  //       $(window).on("scroll", that, that.windowListenerPrev);
  //       // $(window).on("keydown", that, that.keyPressDown);
  //     // }
  //     $("html,body").css("overflow", "auto");
  //     console.log(currentSurrogate, currentSurrogate.offset(), $(window).scrollTop());
  //   }
  // );
}

ocha.HubScrolling.prototype.transition = function(currentPage, nextPage, mode, callback) {
  var that = this;
  // console.log("CALLED!!", currentPage, nextPage, mode, callback);
  if (!mode) {
    mode = "scrollUp";
  }

  var hideThese = that.containers.filter(function(page) {
    return $(page).attr("data-page") != currentPage.attr("data-page") && $(page).attr("data-page") != nextPage.attr("data-page");
  });

  $(hideThese).hide();


  var onInit = nextPage.attr("data-on-init");
  try {
    onInit = eval(onInit);
  } catch (ex) {
    onInit = function() {};
  };

  if ( typeof onInit !== "function" ) {
    onInit = function() {};
  }

  // console.log("ScrollUp : NEXT PAGE ", nextPage, mode);
  switch ( mode ) {
    case "scrollUp":
      that.transitionOngoing = true;
      var h = that.containers.height();
      currentPage.show().css("top", 0); currentPage.css("opacity", 1);
      nextPage.css("top", h); nextPage.css("opacity", 1); nextPage.show();

      // console.log("ScrollUp : NEXT PAGE ", nextPage);

      currentPage.stop(true, true).animate({ top: -h + "px" }, that.options.transitionSpeed,
        function() { if (callback) callback(); });
      nextPage.stop(true, true).animate({ top: "0px" }, that.options.transitionSpeed, function() {that.transitionOngoing=false
        onInit();
      });
    break;

    case "scrollDown":
      that.transitionOngoing = true;
      var h = that.containers.height();
      currentPage.show().css("top", "0px").css("opacity", 1);
      // nextPage.css("opacity", 1);

      nextPage.css("top", "-100%").css("opacity", 1).show();

      // console.log("NEXT PAGE ", nextPage);

      currentPage.stop(true, true).animate({ top: h + "px" }, that.options.transitionSpeed, function() { if (callback) callback(); });
      nextPage.stop(true, true).animate({ top: "0px" }, that.options.transitionSpeed, function() {that.transitionOngoing=false
        onInit();
      });
    break;

    case "fade":
      that.transitionOngoing = true;
      // console.log(nextPage, currentPage);

      currentPage.show().css("opacity", 1).css("top", 0);
      nextPage.show().css("opacity", 1).css("top", 0);

      var nextPageZindex = nextPage.css("zIndex");

      nextPage.css("zIndex", parseInt(currentPage.css("zIndex")) - 10);

      currentPage.stop(true, true).animate({ opacity: 0}, that.options.transitionSpeed, function() { if (callback) callback(); });
      nextPage.stop(true, true).animate({ opacity: 1}, that.options.transitionSpeed, function() {
        that.transitionOngoing=false;
        nextPage.css("zIndex", nextPageZindex);
        currentPage.hide();
        onInit();
      });
    break;

  }
};

/*****

CHART AREA

*****/

// $j("#chart-container").width($(window).width() * 3 / 4);
$j("#chart-container").css("marginLeft", "-" + parseInt($j("#chart-container").width()/2) + "px");
$j("#chart-container").height($(window).height()/2);
var ocha = ocha || {};
ocha.CountryChart = function (container) {
  this.container = $j(container);
  this.d3Container = d3.select(container[0]);
  this.svg = this.d3Container.append("svg").attr("class", "country-chart");
  this.data = [
               { year: 2005, requirement: 5000000000, targeted: 40000000},
               { year: 2006, requirement: 4800000000, targeted: 32000000},
               { year: 2007, requirement: 4400000000, targeted: 26000000},
               { year: 2008, requirement: 6300000000, targeted: 28000000},
               { year: 2009, requirement: 9500000000, targeted: 43000000},
               { year: 2010, requirement: 9500000000, targeted: 53000000},
               { year: 2011, requirement: 7900000000, targeted: 65000000},
               { year: 2012, requirement: 8800000000, targeted: 62000000},
               { year: 2013, requirement: 12900000000, targeted: 73000000},
               { year: 2014, requirement: 16800000000, targeted: 76000000},
               { year: 2015, requirement: 19659704357, targeted: 82463630}
            ];

  this.chart = null;
  this.nodeData = null;
  this.forceLayout = null;

  this.radiusScale;
  this.colorScale;
  this.clipChart;

  this.nodes = null;

  this.initialize = function () {
    var that = this;
    var data = that.data;
    var year = data.map(function(d) { return d.year; });
    var requirements = [];
    var targeted = [];

    // console.log(data, year);

    for (var i in year) {
      // console.log(i, year[i]);
      var filtered = data.filter(function(d) { return d.year == year[i]; });

      // console.log(filtered);

      if ( filtered.length == 0 ) {
        requirements.push(null);
        targeted.push(null);
      } else {
        requirements.push(filtered[0].requirement == undefined ? null : filtered[0].requirement);
        targeted.push(filtered[0].targeted == undefined ? null : filtered[0].targeted);
      }
    }

    that.chart = c3.generate({
        bindto: that.d3Container,
        data: {
          x: 'x',
          columns: [
            ['x'].concat(year),
            ['People Targeted'].concat(targeted),
            ['Funding Requirement'].concat(requirements)
          ],
          axes: {
            'People Targeted' : 'y',
            'Funding Requirement' : 'y2'
          }
        },
        axis: {
          x: {
            tick: {
              format: function(d) {
                // if ( d == 2014 ) {
                //   return "DEC " + d;
                // }
                // else {
                  return "JUN " + d;
                // }
              }
            }
          },
          y: {
            label: {
              text: "People Targeted",
              position: "outer-top"
            },
            tick: {
              format: function(d) {
                var fmt = d3.formatPrefix(d);

                if (fmt.symbol == "G") { fmt.symbol = "B"; }

                return d3.round(fmt.scale(d), 1) + fmt.symbol;
              }
            }
          },
          y2: {
            show: true,
            label: {
              text: "Funding Requirement",
              position: "outer-top"
            },
            tick: {
              format: function(d) {
                var fmt = d3.formatPrefix(d);

                if (fmt.symbol == "G") { fmt.symbol = "B"; }

                return "$" + d3.round(fmt.scale(d), 1) + fmt.symbol;
              }
            }
          }
        },
        colors : {
          "People Targeted" : "#811B1B"
        }
        // oninit: function (d) {
        //     // this.main.append('rect')
        //     //     .style('fill', '#a6c1d0')
        //     //     .attr('x', 0.5)
        //     //     .attr('y', -0.5)
        //     //     .attr('width', this.width)
        //     //     .attr('height', this.height)
        //     //   .transition().duration(3000)
        //     //     .attr('x', this.width)
        //     //     .attr('width', 0)
        //     //   .remove();
        //     that.clipChart = this.clipChart;

        //     // console.log(d, this, this.data);
        //     // this.clipChart.attr("width", 0);
        //     // console.log("CHART IS NOW LOADED ::: ", this, this.clipChart, this.clipChart.attr("width") );
        //     // d3.select(this.clipChart)
        //       // .attr('width', 0);
        //       // .transition().duration(1000)
        //       // .attr('width', this.width);
        // }
    });

    that.chart.data.colors({"People Targeted": "#811B1B"})
  }
};

var ocha = ocha || {};

var titlePlayed = false;
var lastMosaic;

var countryChart = new ocha.CountryChart($("#chart-area"));
var iframeLoaded = false, chartLoaded = false;
var lastMosaicInitialized = false;
ocha.Story = function() {
  return {
    initialize : function() {
      // console.log("Initializing Story", "-" + $(".hub-slide-center-text h2").height()/2 +"px");

      $(".hub-neutral-background div.content").each(function() {
          $(this).css("marginTop", "-" + parseInt($(this).height()/2) +"px");
      });

      if ( hubScrolling.isMobile ) {
        $(".hub-neutral-background div.content").each(function() {
          $(this).css("marginTop", "-=50px");
        });
      }

      $("#mosaic-title-area").css("top", "50%");
      $("#mosaic-title-area").css("marginTop", "-" + parseInt($("#mosaic-title-area").height()/2) +"px");


        // $(window).trigger("resize");
    },
    loadChart: function () {
      if ( !chartLoaded ) {
        countryChart.initialize();
        chartLoaded = true;
      }
    },
    titleToOpening : function (callback) {
      /** Transition from Title page to */
      // console.log("CurrentPage", hubScrolling.currentPageNumber);
      $("#mosaic-area").css("backgroundImage", "url(./img/story/000.jpg?q=x)");
      $("#mosaic-title-area, #mosaic-overlay-area").fadeOut("fast");
      if (!titlePlayed && faceMosaic) {
        faceMosaic.hide(undefined, function() { hubScrolling.nextAction() });
        titlePlayed = true;
      } else {
        hubScrolling.nextAction();
      }


      // console.log("Hello World title to opening");
    },
    reshowImages : function () {
      $("#mosaic-area").css("backgroundImage", "url(./img/story/000.jpg?q=x)");
      $("#mosaic-title-area").fadeIn("fast");
      // faceMosaic.reshowImages();
    },
    titleProcess1 : function() {
      // console.log("TITLE PROCESS ONE");
      $("#mosaic-area #mosaic-title-area, #mosaic-area #mosaic-overlay-area").fadeOut("fast");

    },
    titleProcess2 : function() {
      // console.log("TITLE PROCESS TWO");
    },
    hideGoodShowBad : function () {
      // $("#hub-slide-1-good-news").stop(true, true).fadeOut("fast", function() {
      //   $("#hub-slide-1-bad-news").stop(true, true).fadeIn("fast");
      // });

    },
    showSecondFace : function () {
      $(window).trigger("resize");

      if ( !lastMosaicInitialized ) {
        $("#hub-slide-16 #hub-face-final-area").height($("#hub-slide-16").height());
        $("#hub-slide-16 #hub-face-final-area").empty();
        lastMosaic = new ocha.FaceMosaic("#hub-slide-16 #hub-face-final-area",
                                        d3.range(IMAGE_COUNT)
                                          .map(function(d) { return "./img/faces/" + fmt(d) + ".png"; }),
                                          faceWidth);

        lastMosaicInitialized = true;
      }

      if ( !hubScrolling.isMobile ) {
        lastMosaic.stopMosaic();
        lastMosaic.startMosaic();
      } else {
        lastMosaic.initialize();
        countryChart.initialize();
      }
    },
    playNextChartText: function() {
      $("#content-2-a").stop(true, true).fadeOut("fast", function() {
        $("#content-2-b").stop(true, true).fadeIn("fast");
      });
    },
    hideAllForMap : function() {

      // console.log("ENTERED HERE ?? ");
      $("#hub-slide-16").css("background-image", "url(./img/story/010.jpg)");
      $("#hub-slide-16").css("background-position", "center center");
      $("#hub-slide-16 hub-radial-overlay").fadeOut("fast");

      // lastMosaicInitialized = true;
      if (lastMosaicInitialized) {
        // console.log("ENTERED HERE ?? ", lastMosaic);
        lastMosaic.stopMosaic();
        lastMosaic.hide(undefined, function() { hubScrolling.nextAction(); });
        lastMosaicInitialized = false;
      } else {
        hubScrolling.nextAction();
      }
    },
    remove16_00 : function () {
      // console.log("XXX 00");
      $("#hub-16-00").stop(true, true).fadeOut("fast", function () {
        $("#hub-16-01").stop(true,true).fadeIn("fast");
      });
    },
    remove16_01 : function () {
      // console.log("XXX 01");
      $("#hub-16-01").stop(true, true).fadeOut("fast", function () {
        $("#hub-16-02").stop(true,true).fadeIn("fast");
      });
    },
    remove16_02 : function () {
      // console.log("XXX 02");
      $("#hub-16-02").stop(true, true).fadeOut("fast", function () {
        $("#hub-16-03").stop(true,true).fadeIn("fast");
      });
    },

    startUkraineCounter : function() {
      d3.selectAll("#hub-slide-8 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },
    startIraqCounter : function () {
      d3.selectAll("#hub-slide-4 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    startSyriaCounter : function () {
      d3.selectAll("#hub-slide-5 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    startNepalCounter : function () {
      d3.selectAll("#hub-slide-10 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    startSouthSudanCounter : function () {
      d3.selectAll("#hub-slide-6 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    startYemenCounter : function () {
      d3.selectAll("#hub-slide-7 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },
    startSecondNepalCounter : function () {
      d3.selectAll("#hub-slide-10-a .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    startSomaliaCounter : function () {
      d3.selectAll("#hub-slide-14 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },
    startVanuatuCounter : function () {
      d3.selectAll("#hub-slide-15 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },
    loadGHOMap : function () {
      if (!iframeLoaded) {
        $("iframe#hub-slide-map").attr("src", './map.html?q=' + (Math.random() * 1000));
        iframeLoaded = true;

        setTimeout(function() {$("#loading-map-item").hide();}, 1000);

      }
    },
    finalMap : function() {
      lastMosaic.stopMosaic();
    },

    tweener : function() {
      var target = d3.select(this);
      // console.log(target);
      var i = d3.interpolateRound(0, parseInt(target.attr("data-stat-count")));
      return function(t) {
        // console.log(i(t), this);
        var fP = d3.formatPrefix(i(t));

        if (fP.symbol != "")
        {
          this.textContent = d3.round(fP.scale(i(t)),1) + fP.symbol;
        } else {
          this.textContent = fP.scale(i(t)) + fP.symbol;
        }
      };
    }

  };
}();



/* Creating image list .. */
var fmt = d3.format("03d");
var hubScrolling = new ocha.HubScrolling($j(".hub-section"));
var faceMosaic = null;
// console.log($("#mosaic-area").height());


$("#mosaic-area").css("opacity", 1);

  $("#hub-slide-17 iframe").width($("#hub-slide-17").width());
  $("#hub-slide-17 iframe").height($(window).height());


var win;
jQuery(window).load(function() {

  ocha.Story.initialize();
  hubScrolling.initialize();
  $("#mosaic-actual").height($("#mosaic-area").height());

  faceMosaic = new ocha.FaceMosaic("#mosaic-area #mosaic-actual",
                                     d3.range(IMAGE_COUNT)
                                        .map(function(d) { return "./img/faces/" + fmt(d) + ".png"; }),
                                      faceWidth);


  $j("#facebook-link").on("click", function() {
      var INTERACTIVE_URL = encodeURIComponent("http://www.unocha.org/stateofaid");
      window.open('http://www.facebook.com/sharer.php?u='+ INTERACTIVE_URL,'sharer','toolbar=0,status=0,width=626,height=436');return false;

  });

  $(".twitter-logo").each(function(i, item) {

    $(this).on("click", function() {
      if (win)
      {
        win.close();
      }

      show_text = $(this).find("p").text();

      var param = $.param({
        url: "http://www.unocha.org/stateofaid",
        via: "unocha",
        hashtags: "ReshapeAid",
      });

      win = window.open("https://twitter.com/intent/tweet?" + param, "twitter", "height=300,width=600,modal=yes,alwaysRaised=yes");
      win.focus();
    })


    //$(this).appendTo($link);
  });
});


</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1433955-15', 'auto');
  ga('send', 'pageview');

</script>
</body>
