<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700,800">
<link rel="stylesheet" href="./css/leaflet.css" />
<script src='./js/mapbox.js'></script>
<link href='./css/mapbox.css' rel='stylesheet' />
<link href='./css/c3.css' rel='stylesheet' />
<link href='./css/custom.css' rel='stylesheet' />

<style>
body { margin: 0; padding: 0; }
#mosaic-area {
  background-color: black;
  background-repeat: no-repeat;
  background-size: cover;

  /*background-image: url(./img/story/000.jpg);*/
  background-position: bottom center;
}

#mosaic-overlay-area {

  position: absolute;
  z-index: 1000;
  width: inherit;
  height: inherit;
  opacity: 0.8;

  top: 0;
  left: 0;

  background: -webkit-radial-gradient(white, whitesmoke, gray); /* Safari 5.1 to 6.0 */
  background: -o-radial-gradient(white, whitesmoke, gray); /* For Opera 11.6 to 12.0 */
  background: -moz-radial-gradient(white, whitesmoke, gray); /* For Firefox 3.6 to 15 */
  background: radial-gradient(white, whitesmoke, gray); /* Standard syntax */

}

#mosaic-title-area {
  position: absolute;
  z-index: 2000;
  text-align: center;
  font-family: sans-serif;
  font-weight: bold;

  width: inherit;
  height: inherit;

  top: 0;
  left: 0;

}
#title-content { z-index: 500; }

#mosaic-title-area h1 {
  font-size: 8em;
  padding: 0 1em;
  margin: 0;
  margin-top: 1em;
  text-shadow: 2px 1px 1px rgb(255,255,255);
}

</style>


<body>

<!-- data-next-0="ocha.Story.titleProcess1"
           data-next-1="ocha.Story.titleProcess2" -->
  <section id="mosaic-area" class="hub-section"
           data-next-before="ocha.Story.titleToOpening"
           data-next="fade"

           data-next-after="ocha.Story.reshowImages">
    <div id="mosaic-actual"></div>
    <div id="mosaic-overlay-area"></div>
    <div id="mosaic-title-area">
      <h1>Mid-year Update</h1>
      <h3>A Global Humanitarian Appeals Update (Jan 2015 - Jun 2015)</h3>
    </div>
  </section>

  <section class="hub-section" id="hub-slide-1" data-next="fade">
    <div class='hub-viewport'>
      <div class="content" id="hub-slide-1-good-news">
        <h1>The Good News</h1>
        <p>We are doing more for more people than ever before.</p>
      </div>
    </div>
  </section>

  <section class="hub-section" id="hub-slide-1-a" data-prev="fade" data-next-after="ocha.Story.loadChart">
    <div class='hub-viewport'>
      <div class="content" id="hub-slide-1-bad-news">
        <h1>The Bad News</h1>
        <p>the humanitarian system is under unprecedented strain.</p>
      </div>
    </div>
  </section>

  <section class="hub-section" id="hub-slide-2" style="background-color: white">
    <div class='hub-viewport'>
      <div class='content'>
        <h2>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</h2>
      </div>
      <div id="chart-container">
        <div id="chart-area" class='chart'></div>
      </div>
    </div>
  </section>

  <section class="hub-section hub-neutral-background" data-next="fade" id="hub-slide-3"
          data-next-after="ocha.Story.startIraqCounter">
    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
          <h2>In many countries, violence and insecurity continue to cause massive internal and cross-border displacement. In 2015 alone, we have seen <strong>700,000</strong> people newly displaced.</h2>
      </div>
    </div>
  </section>

  <section class="hub-section" id="hub-slide-4" data-next-after="ocha.Story.startSyriaCounter">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Iraq</h2></div>
      <div class='hub-country-stats'>
          <table>
            <tr>
              <td class='td-right'>
                <span class='country-stat-count' data-stat-count='8200000'>0</span>
              </td>
              <td class='td-left'>
                <span class=''>people in need of assistance</span>
              </td>
            </tr>
            <tr>
              <td class='td-right'>
                <span class='country-stat-count' data-stat-count='2800000'>0</span>
              </td>
              <td class='td-left'>
                people internally displaced
              </td>
            </tr>
            <tr>
              <td class='td-right'>
                <span class='country-stat-count' data-stat-count='60'>0</span>%
              </td>
              <td class='td-left'>
                of frontline humanitarian operations are at risk of shutting down due to overfunding
              </td>
            </tr>
          </table>
      </div>
    </div>
  </section>
  <section class="hub-section" id="hub-slide-5" data-next-after="ocha.Story.startSouthSudanCounter">
    <div class='hub-viewport'>
        <div class='hub-country-title'><h2>Syria</h2></div>
        <div class='hub-country-stats'>
          <table>
            <tr>
                <td class='td-right'><span class='country-stat-count' data-stat-count='7600000'>0</span></td>
                <td class='td-left'>people have been internally displaced<div class="clear"></div></td>
            </tr>
            <tr>
              <td class='td-right'><span class='country-stat-count' data-stat-count='4000000'>0</span></td>
              <td class='td-left'>people internally displaced<div class="clear"></div></td>
            </tr>
            <tr>
              <td class='td-right'><span class='country-stat-count' data-stat-count='4800000'>0</span></td>
              <td class='td-left'>people are living in hard-to-reach or besieged locations<div class="clear"></div></td>
            </tr>
          </table>
        </div>
      </div>
  </section>
  <section class="hub-section"  id="hub-slide-6" data-next-after="ocha.Story.startYemenCounter">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>South Sudan</h2></div>
      <div class='hub-country-stats'>
        <table>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='1500000'>0</span></td>
            <td class='td-left'>internally displaced<div class="clear"></div></td>
          </tr>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='550000'>0</span></td>
            <td class='td-left'>refugees<div class="clear"></div></td>
          </tr>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='4800000'>0</span></td>
            <td class='td-left'>people are severely food insecure<div class="clear"></div></td>
          </tr>
        </table>
      </div>
    </div>
  </section>
  <section class="hub-section" id="hub-slide-7" data-next="fade">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Yemen</h2></div>
      <div class='hub-country-stats'>
        <table>
          <tr><td class='td-right'><span class='country-stat-count' data-stat-count='545000'>0</span></td>
            <td class='td-left'>civilians displaced</td>
          </tr>
        </table>
      </div>
    </div>
  </section>
  <section class="hub-section hub-neutral-background" data-next="fade" id="hub-slide-8">
    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
        <h2><strong>Ukraine</strong> aid agencies have received just</h2>
        <h1>19%</h1>
        <h2>of their needs. This has left many conflict-affected families with no access to emergency shelter</h2>
      </div>
    </div>
  </section>
  <section class="hub-section hub-neutral-background"  data-prev="fade" id="hub-slide-9"
        data-next-after="ocha.Story.startNepalCounter">

    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
        <h2>Natural disasters of devastating proportions continue to wreak havoc, flattening villages and reducing entire livelihood to dust.</h2>
      </div>
    </div>
  </section>
  <section class="hub-section" id="hub-slide-10">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Nepal</h2></div>
      <div class='hub-country-stats'>
        <table>
          <tr>
            <td class='td-right'>
              <span class='country-stat-count' data-stat-count='2800000'>0</span>
            </td>
            <td class='td-left'>people displaced<div class="clear"></div></td>
          </tr>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='3500000'>0</span></td>
            <td class='td-left'>million people need food assistance<div class="clear"></div></td>
          </tr>
        </table>
      </div>
    </div>
  </section>

  <section class='hub-section hub-neutral-background' data-next="fade" id='hub-slide-11'>
    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
        <h2>In many parts of the world, humanitarian crises show no sign of abating.</h2>
        <h1>Protracted is the new normal.</h1>
      </div>
    </div>
  </section>

  <section class='hub-section hub-neutral-background' id="hub-slide-12">
    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
        <h2>
        In the <strong style="color: #99000;">SAHEL</strong> alone</h2>
        <h1>9 million</h1>
        <h2>women, children and men will go hungry this year if aid doesn't reach them.</h2>
      </div>
    </div>
  </section>

  <section class='hub-section hub-neutral-background' id='hub-slide-13' data-next-after="ocha.Story.startSomaliaCounter">
    <div class='hub-viewport'>
      <div class='hub-radial-overlay'></div>
      <div class='content'>
        <h2>
          Aid organizations have achieved a lot so far in 2015. they have saved lives, supported the livelihoods and protected the safety of millions of people.
        </h2>
      </div>
    </div>
  </section>

  <section class='hub-section' id='hub-slide-14'  data-next-after="ocha.Story.startVanuatuCounter">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Somalia</h2></div>
      <div class='hub-country-stats abs-left'>
        <table>
          <tr>
            <td colspan="2">Aid groups provided food assistance to <span class='country-stat-count' data-stat-count='333000'>0</span>people<div class="clear"></div></td>
          </tr>
          <tr>
            <td class='td-right'>
              <span class='country-stat-count' data-stat-count='128000'>0</span></td>
            <td class='td-left'>received seeds, tools, and fishing equipment<div class="clear"></div></td>
          </tr>
        </table>
      </div>
    </div>
  </section>

  <section class='hub-section' id='hub-slide-15' data-next-after="ocha.Story.showSecondFace">
    <div class='hub-viewport'>
      <div class='hub-country-title'><h2>Vanuatu</h2></div>
      <div class='hub-country-stats'>
        <table>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='19500'>0</span></td>
            <td class='td-left'>children vaccinated against measles<div class="clear"></div></td>
          </tr>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='370000'>0</span></td>
            <td class='td-left'>people received food assistance<div class="clear"></div></td>
          </tr>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='47000'>0</span></td>
            <td class='td-left'>people received clean water.<div class="clear"></div></td></tr>
          <tr>
            <td class='td-right'><span class='country-stat-count' data-stat-count='50000'>0</span></td>
            <td class='td-left'>people received emergency shelter assistance.<div class="clear"></div></td>
          </tr>
        </table>
      </div>
    </div>
  </section>

  <section class='hub-section hub-neutral-background' id='hub-slide-16' data-next="fade" data-next-before="ocha.Story.hideAllForMap"
    data-next-0="ocha.Story.remove16_00"
    data-next-1="ocha.Story.remove16_01"
    data-next-2="ocha.Story.remove16_02"
    >
    <div class='hub-viewport'>
      <div id='hub-face-final-area'></div>
      <div class='hub-radial-overlay'></div>
      <div class='content' id="hub-16-00">
        <h2>
          But each year millions of people do not get the help they need because humanitarian access is compromised.
        </h2>
      </div>
      <div class='content' id="hub-16-01" style="display: none">
        <h2>
          Or because the funding does not come through
        </h2>
      </div>
      <div class='content' id="hub-16-02" style="display: none">
        <h2>
          Donors have been generous but the global humanitarian appeal remains just
        </h2>
        <h1>23 per cent</h1>
        <h2>funded half way through the year</h2>
      </div>
      <div class='content' id="hub-16-03" style="display: none">
        <h2>
          One thing is clear: the sheer scale of needs continues to outpace the level of funding
        </h2>
      </div>
    </div>
  </section>

  <section class='hub-section' id='hub-slide-17'>
    <div class='hub-viewport'>
      <div class='content'>
        <iframe id='hub-slide-map' src='./map.html' scrolling="no" border="no" ></iframe>
      </div>
    </div>
  </section>





<script src="./js/jquery-1.11.3.min.js"></script>
<script src="./js/d3.js"></script>
<script src="./js/c3.js"></script>
<script src="./js/topojson.js"></script>
<script src="./js/leaflet.js"></script>

<script type="text/javascript">
$j = jQuery;


var IMAGE_COUNT = 54;

var ANIMATION_DURATION = 1000;

var ocha = ocha || {};

ocha.FaceMosaic = function(selector, imageList, squareSize) {

//Private function to help the hide


  this.TIMEOUT_PERIOD = 2000;

  this.SQUARE_SIZE = squareSize || 50; //suggested square_size
  this.FADE_DURATION = 200;

  this.imageList = imageList;
  this.container = $j(selector);
  this.d3Container = d3.select(selector);
  this.d3Scale = null;

  this.transitionOngoing = false;

  // console.log(this.container);
  this.mW = this.container.width(); //mosaic Width
  this.mH = this.container.height(); //mosaic Height

  //console.log(this.mH, this.mW);

  this.scaleHorizontal = d3.scale.ordinal().domain(d3.range(parseInt(this.mW/this.SQUARE_SIZE) + 2)).rangeRoundBands([0,this.SQUARE_SIZE  * (parseInt(this.mW/this.SQUARE_SIZE) + 2)]);

  this.mosaicIntervalHandler = null;

  this.mosaicDimension = [ this.SQUARE_SIZE  * (parseInt(this.mW/this.SQUARE_SIZE) + 2),
                          this.SQUARE_SIZE  * (parseInt(this.mH/this.SQUARE_SIZE) + 2)]

  this.helper = {

  }

  this.startMosaic = function() {
    var that = this;

    that.mosaicIntervalHandler = setInterval(function() {
      // //console.log("Hello World");
      that.d3Container
        .selectAll("span.mosaic-item")
        .each(function(d) {

          var coinFlip = Math.random() * 100;
          if ( coinFlip > 80 ) {  //get new and replace
            var randomIndex = parseInt(that.imageList.length * Math.random());
            var toBeRemoved = d3.select(this).select("img");

            toBeRemoved
              .attr("data-image-status", "for-removal")
              .style("z-index", "0");

            // //console.log(that.imageList[randomIndex]);
            var toBeAdded = d3.select(this).append("img")
              .attr("data-image-status", "new-image")
              .attr("src", that.imageList[randomIndex])
              .style("opacity", 0)
              .style("z-index", "100");

            toBeAdded.transition()
              .duration(500 + that.TIMEOUT_PERIOD/2)
              .delay(Math.random() * that.TIMEOUT_PERIOD/2)
              .style("opacity", 1)
              .each("end", function() { toBeRemoved.remove(); });
          }

        });

    }, that.TIMEOUT_PERIOD);
  };

  this.stopMosaic = function() {
    var that = this;
    clearTimeout(that.mosaicIntervalHandler);
  };

  this.initialize();
};

ocha.FaceMosaic.prototype.endAllEvent = function ( transition, callback ) {

  var n = 0;
  transition
    .each(function() { ++n; })
    .each("end", function() { if (!--n && callback !== undefined) {

        callback.apply(this, arguments);
    } });
};

ocha.FaceMosaic.prototype.reshowImages = function() {
  var that = this;
  that.mosaicRows.selectAll("span.mosaic-item").style("opacity", 1);
};
ocha.FaceMosaic.prototype.initialize = function () {
  var that = this;
  // console.log(that.d3Container.selectAll);
  that.container.addClass("mosaic-container");
  that.mosaicRows = that.d3Container
                      .selectAll("div.mosaic-row")
                      .data(d3.range(parseInt((this.mH/this.SQUARE_SIZE) + 2)))
                      .enter()
                        .append("div")
                          .attr("class", "mosaic-row")
                          .style("height", that.scaleHorizontal.rangeBand() + "px")
                          .style("width", that.SQUARE_SIZE*(parseInt(that.mW/that.SQUARE_SIZE) + 2) + "px")
                          .attr("data-row-id", function(d) { return "row-id-" + d;})
                          .each(function(d) {
                            //Creating individual item..
                             d3.select(this).selectAll("span.mosaic-item")
                                .data(d3.range(parseInt(that.mW/that.SQUARE_SIZE + 2)))
                                .enter()
                                  .append("span")
                                    .attr("class", "mosaic-item")
                                    .style("width", that.scaleHorizontal.rangeBand() + "px")
                                    .style("height", that.scaleHorizontal.rangeBand() + "px")
                                    .each(function() {
                                      var randomIndex = that.imageList.length * Math.random();

                                      var newImage = d3.select(this).append("img")
                                          .attr("src", that.imageList[parseInt(randomIndex)])
                                          .attr("data-image-status", "new-image")
                                          .style("opacity", 0);

                                      newImage.transition()
                                          .duration(that.FADE_DURATION)
                                          .delay(Math.random() * that.TIMEOUT_PERIOD)
                                          .style("opacity", 1);
                                    })
                          });

    // this.startMosaic();
};

ocha.FaceMosaic.prototype.hide = function (userDefMode, callback) {
  var that = this;
  var mode = "fade";


  if (userDefMode !== undefined) {
    mode = userDefMode;
  }

  // console.log("Callback", callback);

  switch (mode) {
    case "fade" :
      that.d3Container
        .selectAll("span.mosaic-item")
          .transition()
            .duration(that.FADE_DURATION)
            .delay(function() { return Math.random() * that.TIMEOUT_PERIOD; })
            .style("opacity", 0)
            .call(that.endAllEvent, callback);

      break;
    default:
      break;
  }

  // if ( callback ) {
  //   console.log("calling call back");
  //   callback();
  // }
};

//* Hub Section Scrolling */
var ocha = ocha || {};
ocha.HubScrolling = function(sections) {
  var $j = jQuery;
  this.TRANSITION_SPEED = 1000;

  this.scroller = null;

  this.currentSubPage = 0;

  this.currentPage = null, this.nextPage = null;
  this.currentPageNumber = 0;
  this.d3Containers = d3.selectAll(sections[0]);
  this.containers = $j(sections) ;
  this.pageCount = this.containers.length;

  //Scrolling items:
  this.scrollPositionTop = $(window).scrollTop();
  this.scrollPossitionBottom = $(window).scrollTop();
};

ocha.HubScrolling.prototype.windowListenerNext = function(d) {
      //console.log("XXX");
      var that = d.data;

      var h = that.containers.height();
      var limit = h/4; //1/10 of the height;

      var scrollTop = $(window).scrollTop();
      var target = that.surrogates.filter(function(i, item) {
        var topOffset = $(item).offset().top;
        return (topOffset+limit+limit > scrollTop && scrollTop > topOffset+limit);
      });

    // console.log("XXXX", target, scrollTop);

    // if ($(target).length) {
    //   console.log($(target).attr("data-page-scroll"), scrollTop);
    // }

    // console.log(that.currentPageNumber)
    // console.log(target, $(target).attr("data-page-scroll"));
    //Determine if he user scrolled up or down..
    // if ( target.length > 0 ) {
      if (target.length > 0  && scrollTop > that.scrollPositionTop) {
        that.currentPageNumber = parseInt($(target).attr("data-page-scroll"));
        // console.log(that.currentPageNumber);
        // console.log("NEXT()", target, that.currentPageNumber);
        d.data.next();
      }
      // else {
      //   console.log("PREV()", target, that.currentPageNumber);
      // //   // d.data.prev();
      // }
    // }

    that.scrollPositionTop = scrollTop;

    // console.log("HUBSCROLLING ::: ", hubScrolling.scrollPosition);
    //$(window).off("scroll", that.windowListener);

};

ocha.HubScrolling.prototype.windowListenerPrev = function(d) {
    var that = d.data;


    // console.log("XXX");
    var h = that.containers.height();
    var limit = h/4; //1/10 of the height;

    var scrollTop = $(window).scrollTop();
    // console.log(scrollTop);
    var target = that.surrogates.filter(function(i, item) {
      // console.log( "TOP OFFSET :: ", $(item).offset().top );

      var topOffset = $(item).offset().top;

      // console.log(topOffset+limit+5, scrollTop, topOffset+limit);
      // console.log(topOffset-limit, scrollTop, topOffset-limit-5);

      // console.log("RESULT", (topOffset+limit+5 < scrollTop && scrollTop > topOffset+limit) ||
             // (topOffset-limit < scrollTop && scrollTop > topOffset-limit-5));

      // if (topOffset+limit+50 > scrollTop && scrollTop > topOffset+limit) {
      //   // console.log("TOP OFFSET " , limit,  topOffset);
      // }

      return (topOffset-limit > scrollTop && scrollTop > topOffset-limit-limit);

    });

    // console.log("XXXX", target.length, scrollTop);

    // if ($(target).length) {
    //   console.log($(target).attr("data-page-scroll"), scrollTop);
    // }


    // console.log(target, $(target).attr("data-page-scroll"));
    //Determine if he user scrolled up or down..
    if (target.length > 0  && scrollTop < that.scrollPositionBottom) {
      that.currentPageNumber = parseInt($(target).attr("data-page-scroll"));
      // if (scrollTop > that.scrollPosition) {
        // console.log("PREV()", target, that.currentPageNumber, that);
        that.previous();
      // }
      // else {
      //   console.log("PREV()", target);
      //   // d.data.prev();
      // }
    }

    that.scrollPositionBottom = scrollTop;

    // console.log("HUBSCROLLING ::: ", hubScrolling.scrollPosition);
    //$(window).off("scroll", that.windowListener);

}


ocha.HubScrolling.prototype.initialize = function() {
  var that = this;
  that.resizeWindow();

  var scrollTop = $("html,body").scrollTop();
  // console.log("!!! SCROLL TOP: ", scrollTop);
  //Add data-page counter;
  this.containers.each(
      function(i, item) {

        $j(item)
          .attr("data-page", i)
          .css({
              "position": "fixed",
              "zIndex" : ( that.pageCount - i ) * 100,
              "top" : i != 0 ? that.containers.height() : 0,
              "left" : 0
          });

          //Insert surrogate containers
          var $surrogate = $("<div />")
                          .addClass("hub-container-scroll hub-surrogate")
                          .attr("data-page-scroll", i)
                          .width(that.containers.width())
                          .height(that.containers.height());


          $("body").append($surrogate);

          // if ($surrogate.position().top < scrollTop) {
          //   $surrogate.css("visibility", "hidden");
          // }

      }
  );

  this.containers.each(function(i, item) {
      var $target = $("[data-page-scroll=" + i+ "]");

      // console.log("DISTANCE", i,  $(window).scrollTop(), $("[data-page-scroll=" + i+ "]").offset().top - $(window).scrollTop());

      if ($target.offset().top - $(window).scrollTop() < 0) {
        // console.log("HIDDEN : ", $($(".hub-section")[i]));
        $($(".hub-section")[i]).css("top", "100%");

      }
      else {
        $($(".hub-section")[i]).css("opacity", 1)
        $($(".hub-section")[i]).css("top", "0px")
      }


  });

  this.surrogates = $("body > .hub-surrogate");


    $(window).on("scroll", that, that.windowListenerNext);
    $(window).on("scroll", that, that.windowListenerPrev);

  //Event listeners
  $j(window).on("resize", function () { that.resizeWindow(); });
};

ocha.HubScrolling.prototype.resizeWindow = function() {
  var that = this;
  var $window = $j(window);
  var w = $window.width(),
      h = $window.height();

  that.containers.width(w);
  that.containers.height(h);

  //For the scroller at the background
  // if (!this.scroller) {
  //   var wAll = that.containers.width(),
  //       hAll = that.containers.height() * pageCount;
  // }
};

ocha.HubScrolling.prototype.previous = function() {
  $("html,body").css("overflow", "hidden");

  var that = this;

  // console.log("XXXXX");

  $(window).off("scroll", that.windowListenerNext);
  $(window).off("scroll", that.windowListenerPrev);

  var currentPage = $(this.containers.filter(function(d, item) { return parseInt($(item).attr("data-page")) == that.currentPageNumber; }));

  var currentSurrogate = $(this.surrogates.filter(function(d, item) { return parseInt($(item).attr("data-page-scroll")) == that.currentPageNumber; }));


  // console.log(currentPage, currentSurrogate);
  nextPage = this.containers.filter(function(d, item) { return parseInt($(item).attr("data-page")) == that.currentPageNumber-1; });

    var mode = "scrollDown";

    if ( currentPage.attr("data-prev") !== undefined ) {
      mode = currentPage.attr("data-prev");
    }

    var callback = currentPage.attr("data-prev-after");
    // console.log("Mode, Callback", currentPage, mode, callback);

    var func = null;
    if (callback !== undefined) {
      func = eval(callback);
    } else {
      func = function(){};
    }

    that.currentPageNumber --;

    //Scroll towards new surrogaete
    var currentSurrogate = $(that.surrogates.filter(function(d, item) { return parseInt($(item).attr("data-page-scroll")) == that.currentPageNumber; }));

    that.transition(currentPage, nextPage, mode, func);

    //Reset Subpage
    that.currentSubPage = 0;

    $("body").animate({ scrollTop : currentSurrogate.offset().top}, that.TRANSITION_SPEED,
      function() {

        that.transitionOngoing = false;
        that.scrollPositionTop = $(window).scrollTop();
        that.scrollPossitionBottom = $(window).scrollTop();
        // console.log("XX");
        $(window).on("scroll", that, that.windowListenerNext);
        $(window).on("scroll", that, that.windowListenerPrev);
        $("html,body").css("overflow", "auto");
      }
    );
};

ocha.HubScrolling.prototype.next = function() {
  $("html,body").css("overflow", "hidden");
  var that = this;
  // var that = this;
  $(window).off("scroll", that.windowListenerNext);
  $(window).off("scroll", that.windowListenerPrev);

  var currentPage = $(this.containers.filter(function(d, item) { return parseInt($(item).attr("data-page")) == that.currentPageNumber; }));

  var currentSurrogate = $(that.surrogates.filter(function(d, item) { return parseInt($(item).attr("data-page-scroll")) == that.currentPageNumber; }));


  // console.log(currentPage, currentPage.attr("data-current-subpage"))
  var currentSubPage = currentPage.attr("data-current-subpage") || 0;
  console.log("Entered here");
  if ( currentPage.attr("data-next-" + currentSubPage) != undefined ) {
    console.log("Entered here too");
    // console.log("CURRENT SUBPAGE", currentSubPage);
    currentSubPage = parseInt(currentSubPage);
    currentPage.attr("data-subpage", currentSubPage);
    var action = currentPage.attr("data-next-" + currentSubPage);
    var func = eval(action);

    // console.log("Assessing subpages." , func, action);

    //Execute Subpage
    func();
    currentPage.attr("data-current-subpage", currentSubPage + 1);

    // setTimeout(function() {
    //   // console.log("TURNED ON");

    //   // $("#hub-scrolling-scroller-component").show();
    // }, 500);
    $("body").animate({ scrollTop : currentSurrogate.offset().top}, that.TRANSITION_SPEED,
      function() {
        // console.log("XXXXX About to body");
        that.transitionOngoing = false;
        that.scrollPositionTop = $(window).scrollTop();
        that.scrollPossitionBottom = $(window).scrollTop();
        $(window).on("scroll", that, that.windowListenerNext);
        $(window).on("scroll", that, that.windowListenerPrev);
        $("html,body").css("overflow", "auto");
      }
    );
  }
  else
  {
    console.log("Entered here 3");
    currentPage.attr("data-current-subpage", currentSubPage+1);
    nextPage = this.containers.filter(function(d, item) { return parseInt($(item).attr("data-page")) == that.currentPageNumber+1; });

    this.nextPage = nextPage;
    this.currentPage = currentPage;

    var beforeAction = currentPage.attr("data-next-before");
    var func = null;

    try { func = eval(beforeAction); } catch (ex) { func = null; }

    // console.log(beforeAction, func);
    if (beforeAction && func) {
      console.log("Entered here Y", func);
      func();
    }
    else {
      console.log("Entered here X");
      that.nextAction();
    }

  }
};

ocha.HubScrolling.prototype.nextAction = function() {
  //Disable scrolling...

  // console.log("DISABLING NEXT ACTION:::");
  console.log("Entered Here");

  var that = this;
  // console.log(that, that.currentPageNumber);
  var currentPage = that.currentPage;
  var nextPage = that.nextPage;

  var mode = $(currentPage).attr("data-next");

  var callback = $(currentPage).attr("data-next-after");
  // console.log("Mode, Callback", currentPage, mode, callback);

  var func = null;
  if (callback !== undefined) {
    try {
      console.log("Entered Here", func);
      func = eval(callback);
    } catch (ex) { func = null; }

    // console.log(func);

  } else {
    func = function(){};
  }

  that.currentPageNumber ++;

  // console.log("nextAction", that.surrogates);

  //Scroll towards new surrogaete
  var currentSurrogate = $(that.surrogates.filter(function(d, item) {
    // console.log($(item).attr("data-page-scroll"), that.currentPageNumber);
    return parseInt($(item).attr("data-page-scroll")) == that.currentPageNumber; }));

  // console.log(currentSurrogate);

  that.transition(currentPage, nextPage, mode, func);

  //Reset Subpage
  that.currentSubPage = 0;

  console.log("Entered Here", that);

  $("body").animate({ scrollTop : currentSurrogate.offset().top}, that.TRANSITION_SPEED,
    function() {
      // console.log("XXXXX About to body");
      console.log("Entered Here");
      that.transitionOngoing = false;
      that.scrollPositionTop = $(window).scrollTop();
      that.scrollPossitionBottom = $(window).scrollTop();
      $(window).on("scroll", that, that.windowListenerNext);
      $(window).on("scroll", that, that.windowListenerPrev);
      $("html,body").css("overflow", "auto");
    }
  );
}

ocha.HubScrolling.prototype.transition = function(currentPage, nextPage, mode, callback) {
  var that = this;
  // console.log("CALLED!!", currentPage, nextPage, mode, callback);
  if (!mode) {
    mode = "scrollUp";
  }

  // console.log("ScrollUp : NEXT PAGE ", nextPage, mode);
  switch ( mode ) {
    case "scrollUp":
      that.transitionOngoing = true;
      var h = that.containers.height();
      currentPage.show().css("top", 0); currentPage.css("opacity", 1);
      nextPage.css("top", h); nextPage.css("opacity", 1); nextPage.show();

      // console.log("ScrollUp : NEXT PAGE ", nextPage);

      currentPage.stop(true, true).animate({ top: -h + "px" }, that.TRANSITION_SPEED,
        function() { if (callback) callback(); });
      nextPage.stop(true, true).animate({ top: "0px" }, that.TRANSITION_SPEED, function() {that.transitionOngoing=false});
    break;

    case "scrollDown":
      that.transitionOngoing = true;
      var h = that.containers.height();
      currentPage.show().css("top", "0px").css("opacity", 1);
      // nextPage.css("opacity", 1);

      nextPage.css("top", "-100%").css("opacity", 1).show();

      // console.log("NEXT PAGE ", nextPage);

      currentPage.stop(true, true).animate({ top: h + "px" }, that.TRANSITION_SPEED, function() { if (callback) callback(); });
      nextPage.stop(true, true).animate({ top: "0px" }, that.TRANSITION_SPEED, function() {that.transitionOngoing=false});
    break;

    case "fade":
      that.transitionOngoing = true;
      // console.log(nextPage, currentPage);

      currentPage.show().css("opacity", 1).css("top", 0);
      nextPage.show().css("opacity", 0).css("top", 0);


      currentPage.stop(true, true).animate({ opacity: 0}, that.TRANSITION_SPEED, function() { if (callback) callback(); });
      nextPage.stop(true, true).animate({ opacity: 1}, that.TRANSITION_SPEED, function() {
        that.transitionOngoing=false;
        currentPage.hide();
      });
    break;

  }
};

/*****

CHART AREA

*****/

$j("#chart-area").width($(window).width());
$j("#chart-area").height($(window).height()/2);
var ocha = ocha || {};
ocha.CountryChart = function (container) {
  this.container = $j(container);
  this.d3Container = d3.select(container[0]);
  this.svg = this.d3Container.append("svg").attr("class", "country-chart");
  this.data = [ { year: 2003, requirement: 5300000000},
               { year: 2004, requirement: 3000000000},
               { year: 2005, requirement: 5000000000, targeted: 40000000},
               { year: 2006, requirement: 4800000000, targeted: 32000000},
               { year: 2007, requirement: 4400000000, targeted: 26000000},
               { year: 2008, requirement: 6300000000, targeted: 28000000},
               { year: 2009, requirement: 9500000000, targeted: 43000000},
               { year: 2010, requirement: 9500000000, targeted: 53000000},
               { year: 2011, requirement: 7900000000, targeted: 65000000},
               { year: 2012, requirement: 8800000000, targeted: 62000000},
               { year: 2013, requirement: 12900000000, targeted: 73000000},
               { year: 2014},
               { year: 2015}
            ];

  this.chart = null;
  this.nodeData = null;
  this.forceLayout = null;

  this.radiusScale;
  this.colorScale;

  this.nodes = null;

  this.initialize = function () {
    var that = this;
    var data = that.data;
    var year = data.map(function(d) { return d.year; });
    var requirements = [];
    var targeted = [];

    console.log(data, year);

    for (var i in year) {
      console.log(i, year[i]);
      var filtered = data.filter(function(d) { return d.year == year[i]; });

      console.log(filtered);

      if ( filtered.length == 0 ) {
        requirements.push(null);
        targeted.push(null);
      } else {
        requirements.push(filtered[0].requirement == undefined ? null : filtered[0].requirement);
        targeted.push(filtered[0].targeted == undefined ? null : filtered[0].targeted);
      }
    }

    that.chart = c3.generate({
        bindto: that.d3Container,
        data: {
          x: 'x',
          columns: [
            ['x'].concat(year),
            ['People Targeted'].concat(targeted),
            ['Funding Requirement'].concat(requirements)
          ],
          axes: {
            'People Targeted' : 'y',
            'Funding Requirement' : 'y2'
          }
        },
        axis: {
          y2: {
            show: true
          }
        },
        oninit: function () {
            this.main.append('rect')
                .style('fill', 'white')
                .attr('x', 0.5)
                .attr('y', -0.5)
                .attr('width', this.width)
                .attr('height', this.height)
              .transition().duration(3000)
                .attr('x', this.width)
                .attr('width', 0)
              .remove();
        }
    });
  }
};

var ocha = ocha || {};

var titlePlayed = false;
var lastMosaic;

var countryChart = new ocha.CountryChart($("#chart-area"));

var lastMosaicInitialized = false;
ocha.Story = function() {
  return {
    initialize : function() {
      // console.log("Initializing Story", "-" + $(".hub-slide-center-text h2").height()/2 +"px");
      $(".hub-neutral-background div.content").css("marginTop", "-" + parseInt($(".hub-neutral-background div.content").height()/2) +"px");

        // $(window).trigger("resize");
    },
    loadChart: function () {
      console.log("ENTERED HERE --> Load chart...");
      countryChart.initialize();
    },
    titleToOpening : function (callback) {
      /** Transition from Title page to */
      // console.log("CurrentPage", hubScrolling.currentPageNumber);
      $("#mosaic-area").css("backgroundImage", "url(./img/story/000.jpg)");
      $("#mosaic-title-area, #mosaic-overlay-area").fadeOut("fast");
      if (!titlePlayed && faceMosaic) {
        faceMosaic.hide(undefined, function() { hubScrolling.nextAction() });
        titlePlayed = true;
      } else {
        hubScrolling.nextAction();
      }


      // console.log("Hello World title to opening");
    },
    reshowImages : function () {
      $("#mosaic-area").css("backgroundImage", "url(./img/story/000.jpg)");
      $("#mosaic-title-area").fadeIn("fast");
      // faceMosaic.reshowImages();
    },
    titleProcess1 : function() {
      // console.log("TITLE PROCESS ONE");
      $("#mosaic-area #mosaic-title-area, #mosaic-area #mosaic-overlay-area").fadeOut("fast");

    },
    titleProcess2 : function() {
      // console.log("TITLE PROCESS TWO");
    },
    hideGoodShowBad : function () {
      // $("#hub-slide-1-good-news").stop(true, true).fadeOut("fast", function() {
      //   $("#hub-slide-1-bad-news").stop(true, true).fadeIn("fast");
      // });

    },
    showSecondFace : function () {
      $(window).trigger("resize");

      if ( !lastMosaicInitialized ) {
        $("#hub-slide-16 #hub-face-final-area").height($("#hub-slide-16").width());
        $("#hub-slide-16 #hub-face-final-area").empty();
        lastMosaic = new ocha.FaceMosaic("#hub-slide-16 #hub-face-final-area",
                                        d3.range(IMAGE_COUNT)
                                          .map(function(d) { return "./img/faces/" + fmt(d) + ".png"; }),
                                          40);

        lastMosaicInitialized = true;
        // lastMosaic.initialize();
      }

      lastMosaic.stopMosaic();
      lastMosaic.startMosaic();
    },
    hideAllForMap : function() {

      console.log("ENTERED HERE ?? ");
      $("#hub-slide-16").css("background-image", "url(./img/story/010.jpg)");
      $("#hub-slide-16").css("background-position", "center center");
      $("#hub-slide-16 hub-radial-overlay").fadeOut("fast");

      // lastMosaicInitialized = true;
      if (lastMosaicInitialized) {
        console.log("ENTERED HERE ?? ", lastMosaic);
        lastMosaic.stopMosaic();
        lastMosaic.hide(undefined, function() { hubScrolling.nextAction(); });
        lastMosaicInitialized = false;
      } else {
        hubScrolling.nextAction();
      }
    },
    remove16_00 : function () {
      // console.log("XXX 00");
      $("#hub-16-00").stop(true, true).fadeOut("fast", function () {
        $("#hub-16-01").stop(true,true).fadeIn("fast");
      });
    },
    remove16_01 : function () {
      // console.log("XXX 01");
      $("#hub-16-01").stop(true, true).fadeOut("fast", function () {
        $("#hub-16-02").stop(true,true).fadeIn("fast");
      });
    },
    remove16_02 : function () {
      // console.log("XXX 02");
      $("#hub-16-02").stop(true, true).fadeOut("fast", function () {
        $("#hub-16-03").stop(true,true).fadeIn("fast");
      });
    },

    startIraqCounter : function () {
      d3.selectAll("#hub-slide-4 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    startSyriaCounter : function () {
      d3.selectAll("#hub-slide-5 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    startNepalCounter : function () {
      d3.selectAll("#hub-slide-10 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    startSouthSudanCounter : function () {
      d3.selectAll("#hub-slide-6 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    startYemenCounter : function () {
      d3.selectAll("#hub-slide-7 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    startSomaliaCounter : function () {
      d3.selectAll("#hub-slide-14 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },
    startVanuatuCounter : function () {
      d3.selectAll("#hub-slide-15 .hub-country-stats span.country-stat-count")
      .transition()
      .duration(1500)
      .tween("text", ocha.Story.tweener);
    },

    finalMap : function() {
      lastMosaic.stopMosaic();
    },

    tweener : function() {
      var target = d3.select(this);
      console.log(target);
      var i = d3.interpolateRound(0, parseInt(target.attr("data-stat-count")));
      return function(t) {
        console.log(i(t), this);
        var fP = d3.formatPrefix(i(t));

        if (fP.symbol != "")
        {
          this.textContent = d3.round(fP.scale(i(t)),1) + fP.symbol;
        } else {
          this.textContent = fP.scale(i(t)) + fP.symbol;
        }
      };
    }

  };
}();

ocha.Story.initialize();


/* Creating image list .. */
var fmt = d3.format("03d");
var hubScrolling = new ocha.HubScrolling($j(".hub-section"));
var faceMosaic = null;
// console.log($("#mosaic-area").height());


$("#mosaic-area").css("opacity", 1);

  $("#hub-slide-17 iframe").width($("#hub-slide-17").width());
  $("#hub-slide-17 iframe").height($(window).height());


jQuery(window).load(function() {
  hubScrolling.initialize();
  $("#mosaic-actual").height($("#mosaic-area").height());
  faceMosaic = new ocha.FaceMosaic("#mosaic-area #mosaic-actual",
                                     d3.range(IMAGE_COUNT)
                                        .map(function(d) { return "./img/faces/" + fmt(d) + ".png"; }));

});

</script>
</body>
